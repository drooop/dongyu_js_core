# 架构评价与改进建议

> 本文档记录对项目架构的评价、已知问题和改进方向。属于设计反思文档，按需查阅。
>
> 最后更新：2026-02-04

---

## 1. 架构优点

### 1.1 概念一致性强

整个架构围绕"ModelTable 是唯一真相"这一原则展开，没有出现概念分裂：
- 数据、UI、程序、流程都用 Cell 描述
- UI 只是投影，不持有独立状态
- 所有交互归结为"写格子"

这种一致性在实际项目中很难维持，说明设计者有很强的纪律性。

### 1.2 工程纪律严格

- **Iteration workflow**：强制"先文档后代码"，Phase 1 禁止写代码
- **验证脚本**：`scripts/validate_*.mjs` 覆盖关键路径
- **行为 Oracle**：PICtest 作为参考实现，避免"拍脑袋设计"
- **执行宪法**：AGENTS.md 不可修改，确保规则稳定

这种严格性对于单人或小团队维护复杂系统非常有价值。

### 1.3 抽象层次合理

- 总线抽象不绑定具体实现（MQTT 可换 Matrix）
- UI 通过 AST 中间层解耦，理论上可换渲染器
- Cell 的 `k` 类型可扩展

---

## 2. 已知问题

### 2.1 学习曲线陡峭

要理解这个系统，必须同时掌握：
- ModelTable/Cell 语义
- 内建 `k` 关键字的行为
- UI AST 规范
- 双总线架构
- Iteration 工作流

对于新加入者（人或 AI）认知负担较高。文档虽然详尽，但分散在多个 SSOT 文件中。

### 2.2 调试链路较长

当 UI 不符合预期时，问题可能出在：
1. Cell 值本身
2. 程序模型的触发器
3. UI AST 的生成逻辑
4. Renderer 的解释
5. 总线消息丢失

目前的 `eventLog` 和 `mqttTrace` 是好的开始，但缺少"端到端链路追踪"能力。

### 2.3 性能未验证

ModelTable 作为统一抽象，每次状态变化都经过完整的解释执行路径。对于复杂场景（大表格、高频更新），性能表现未知。

### 2.4 目标用户定位模糊

- 如果目标是开发者：当前抽象层次可能"太低"（写 Cell 比写 Vue 组件更繁琐）
- 如果目标是非开发者：缺少可视化编辑能力

---

## 3. 改进建议

### 3.1 短期（值得优先做）

| 建议 | 理由 | 预期收益 |
|------|------|----------|
| 可视化调试工具 | 展示 Cell → Trigger → Side Effect → UI 完整链路 | 大幅降低调试成本 |
| 错误边界明确化 | Cell 类型不匹配、触发器执行失败时给出清晰错误和位置 | 减少排查时间 |
| 渐进式文档 | 10 分钟 Quick Start，只讲最小可运行路径 | 降低上手门槛 |

### 3.2 中期（可以考虑）

| 建议 | 理由 | 注意事项 |
|------|------|----------|
| 性能基准测试 | 在 `scripts/` 中增加性能验证，定义可接受阈值 | 需要确定典型场景 |
| 类型系统增强 | Cell 的 `t` 字段目前是字符串，可结构化 | 需权衡复杂度 |
| 端到端链路 ID | 每次用户交互分配唯一 ID，贯穿整个链路 | 便于日志关联 |

### 3.3 长期（需要权衡）

| 建议 | 理由 | 风险 |
|------|------|------|
| DSL 或可视化编辑器 | 降低非开发者使用门槛 | 增加系统复杂度 |
| 多渲染器支持 | 适配小程序、React Native 等 | 维护成本增加 |

---

## 4. 是否值得继续做

**结论：值得**

理由：
1. **"模型驱动"是有价值的范式**——低代码/无代码平台的核心也是类似理念
2. **架构足够灵活**——双总线设计支持本地和分布式部署
3. **工程纪律保证可维护性**——严格的 Iteration 流程让单人也能管理复杂系统

需要警惕：
- "通用性"和"易用性"之间需要找到平衡点
- 最大的挑战不是技术实现，而是如何降低使用门槛

---

## 5. 参考资料

- 架构 SSOT：`docs/architecture_mantanet_and_workers.md`
- 运行时语义：`docs/ssot/runtime_semantics_modeltable_driven.md`
- 工作流规范：`docs/WORKFLOW.md`
