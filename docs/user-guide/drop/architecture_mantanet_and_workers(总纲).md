# 云海流核心概念与架构边界（SSOT）

> 目的：沉淀“云海流（云海流）模型化体系”在 dongyu / V1N / PICtest 语境下的**稳定概念、不变量与边界**，作为仓库内的唯一事实来源（Single Source of Truth, SSOT）。
>
> 适用范围：所有方案设计、文档、测试脚本、以及代码实现讨论，均必须以本文档定义的术语与边界为准。
>
> 说明：本文档**不以源码路径为中心**（那属于实现导览文档），而以“概念宪法”为中心；实现细节可在独立的 `v1n_concept_and_implement.md` 中维护。

---

## 0. 不变量与设计目标

### 0.1 总体目标
云海流的目标是：用**模型表（ModelTable）**作为统一抽象，驱动**软件工人（Software Worker）**执行与**滑动 UI（Sliding UI）**呈现，实现“自上而下统一管控”的工业数字化/智能化平台能力，并能在多终端以“小系统（App-as-OS）”形态交付。

### 0.2 核心不变量（必须长期成立）
- **模型驱动**：业务能力优先由模型表描述，代码是运行时与扩展，不是唯一事实来源。
- **应用层扩展**：除模型表核心数据依赖外，基座内的应用层能力应由 ModelTable 的模型能力（数据/程序/流程/UI/文档）提供；系统级扩展通过“系统自带的负数 model_id 模型”承载，避免改动基座核心层语义边界。
- **UI 是投影**：滑动 UI 是模型表的投影与交互入口，UI 不应承载业务真相。
- **执行在工人**：软件工人承担业务逻辑执行、流程推进与状态演进；终端壳负责呈现与交互。
- **总线解耦**：消息、指令、状态更新应通过“总线抽象”解耦，不绑定具体实现名。
- **工作区隔离**：跨网络/跨组织的协作必须在“工作区（Workspace）”边界内进行隔离与加密。
- **可审计可验证**：任何关键能力必须有脚本化验收路径；关键变更可回滚、可追踪。

---

## 1. 系统形态：小系统（App-as-OS）与可安装小应用

### 1.1 小系统（Micro App OS / App-as-OS）
- **定义**：dongyu 作为宿主壳（桌面/移动端），提供统一的账号态、资源管理、权限边界与运行环境；其上运行多个“能力模块/小应用”。
- **不是什么**：
  - 不是单一业务 App（例如“只做聊天”）。
  - 不是把所有业务写死在壳层代码里。
- **不变量**：
  - 顶层信息架构应以“应用/工作台/能力模块”组织，而不是某个单一功能为中心。
  - 系统级能力（安装、更新、权限、日志、诊断）应由小系统承接。

### 1.2 可安装小应用（ModelTable + Sliding UI App）
- **定义**：由模型表描述的“可安装包”，运行时加载模型表并由滑动 UI 渲染。
- **生命周期**：安装 → 启动 → 运行 → 停止 → 卸载（均可被记录与审计）。
- **不变量**：
  - 小应用的 UI 与行为来自模型表；壳仅提供容器与系统能力。
  - 安装/更新必须具备来源校验、版本记录与回滚策略。

### 1.3 内建能力模块（Built-in Capability App）
- **定义**：由小系统内建实现的系统级能力（例如通讯、账号、设置、诊断），在用户感知上可以以“小应用”形式呈现，但其实现不一定是模型表驱动。
- **不变量**：
  - 其地位应与可安装小应用并列，而非强行压过整个系统叙事。

---

## 2. 软件工人（Software Worker）与软件工人基座（Worker Base）

### 2.1 软件工人（Software Worker）
- **定义**：执行实际业务逻辑的后端执行单元，由模型表驱动，响应来自滑动 UI 或总线的指令，产出状态与结果，并通过总线回传。
- **职责边界（做什么）**：
  - 执行业务函数、任务与流程
  - 维护业务状态（由模型表与持久化共同定义）
  - 对外暴露可被系统集成的能力接口（抽象层）
- **职责边界（不做什么）**：
  - 不承担终端 UI 的呈现与交互编排
  - 不把某个通讯实现写死为唯一通道
- **不变量**：
  - 工人的可观测性（日志/状态/错误）必须可被系统读取与审计。

### 2.2 软件工人基座（Worker Base / PICtest / V1N Runtime）
- **定义**：软件工人的运行时与管理界面/工具集合（可包含管理 UI、模型编辑器、诊断工具等），用于加载、运行与维护模型表驱动的能力。
- **关系**：
  - Worker Base 是“运行时容器 + 工具链”，Software Worker 是“执行实例/执行单元”。
- **不变量**：
  - 基座的集成必须可沉淀（runbook + 脚本验收），避免每次上游变更导致宿主系统崩溃。
  - 基座必须支持“能力探测/降级”：在缺失依赖或资源时可关闭或提供明确 fallback，而不是无提示崩溃。

---

## 3. 模型表（ModelTable）与单元格（Cell）

### 3.1 ModelTable
- **定义**：系统的核心数据结构，由大量 Cell 组成；模型表既可描述数据结构，也可描述程序、流程、文档与 UI。
- **分层（概念层）**：
  - 数据模型：定义字段与元数据
  - 程序模型：定义处理过程与协程任务
  - 流程模型：由“起/承/转/合”节点组织的执行流
  - 文档模型：展示与编辑内容
  - UI 模型：以 UI 组件为基础的可渲染描述
- **不变量**：
  - 模型表是“可持久化、可版本化、可迁移”的。
  - 模型表的变更必须可审计（谁改了、何时改、影响什么）。

### 3.2 Cell
- **定义**：模型表中的最小单元，包含结构化字段（例如 plcktv 等）用于描述 UI、状态、逻辑、触发与数据。
- **不变量**：
  - Cell 字段语义必须在运行时内保持一致（不得随意改解释规则）。
  - 触发与副作用必须可观察（日志/状态回写/事件记录）。

---

## 4. 滑动 UI（Sliding UI）

- **定义**：终端 UI 不是写死的界面，而是由模型表动态渲染；交互事件被转换为可路由的消息/指令，并驱动模型表状态变化。
- **不变量**：
  - UI 变更优先通过模型表与 token/规范完成，而不是散落硬编码。
  - UI 事件必须可追踪到模型表的某个 Cell 或某条执行路径（可解释性）。

---

## 5. 总线抽象：管理总线、控制总线与 MBR

> 本节为抽象概念定义，不绑定具体实现名。

### 5.1 管理总线（Management Bus）
- **定义**：承载“用户交互事件、会话、通知、UI 状态更新”等高层消息的逻辑通道。
- **不变量**：
  - 面向人/面向交互，强调可达性与可追踪性。
  - 允许端到端加密/鉴权等安全策略叠加。

### 5.2 控制总线（Control Bus）
- **定义**：承载“指令下发、设备控制、工人执行结果回传”等控制类消息的逻辑通道。
- **不变量**：
  - 面向执行与控制，强调可靠性、时序与审计。
  - 与管理总线在语义上区分，避免混用导致权限边界模糊。

### 5.3 MBR（Message Bridge Robot）
- **定义**：管理总线与控制总线之间的桥接者，负责消息转发、协议适配与安全策略执行。
- **不变量**：
  - 是系统枢纽，必须可观测（日志、指标、异常追踪）。
  - 必须执行策略：鉴权、过滤、限流、审计、重放保护（至少具备策略接口）。

- 直达 path（in-proc transport）仅替换传输层，不绕过 ModelTable 语义，详见 `docs/ssot/runtime_semantics_modeltable_driven.md`。

---

## 6. 工作区（Workspace）：隔离与安全边界

- **定义**：在进入控制总线前的隔离网络与安全边界，提供数据分离、通讯加密与节点信任组织能力。
- **不变量**：
  - 工作区之间数据隔离（默认不互通）。
  - 通讯必须加密，且具备可撤销的信任关系。
  - 能支持网状节点/多端接入的安全策略（抽象要求，不绑定实现）。

---

## 7. 多平台交付与集成原则（Windows / Linux / macOS / Android）

- **目标平台**：近期主攻 Windows、Linux、macOS、Android。
- **不变量**：
  - 集成经验必须沉淀为 runbook（按平台拆分）。
  - 所有关键能力必须可脚本化验收（避免仅靠 GUI 手测）。
  - 任何上游变更都必须有“能力探测与降级”策略，避免一处崩溃拖垮整个系统。

---

## 8. 可观测性与验收（必须具备的工程属性）

### 8.1 最小可观测性集合
- 运行时日志（按模块/按组件分类）
- 执行状态（成功/失败/耗时/错误码）
- 关键资源状态（模型表加载、连接状态、工作区状态）
- 审计记录（谁触发、触发了什么、结果如何）

### 8.2 验收要求（脚本化）
- 每个核心能力必须给出：
  - 验收脚本入口（命令）
  - PASS/FAIL 判定条件
  - 失败时的诊断指引
- 禁止把“人工打开页面看一眼”作为唯一验收方式。

---

## 9. 术语使用规则（写文档/写代码时必须遵守）

- **必须使用本文术语**：
  - 小系统（App-as-OS）
  - 可安装小应用（ModelTable + Sliding UI App）
  - 内建能力模块（Built-in Capability App）
  - 软件工人（Software Worker）
  - 软件工人基座（Worker Base）
  - 模型表（ModelTable）/ 单元格（Cell）
  - 管理总线 / 控制总线 / MBR
  - 工作区（Workspace）
- **禁止把具体实现名当成主叙事**：
  - 可以在附注中写“现有实现（不展开）”，但正文必须保持抽象。
- **不确定即标注**：
  - 对于尚未被事实验证的内容，必须标注“待确认”，并写明确认方法。

---

## 10. 与实现导览文档的关系

- 本文档（SSOT）是概念宪法：稳定、不频繁变更。
- 实现导览与源码佐证应放在独立文档（例如 `docs/v1n_concept_and_implement.md`）：
  - 允许随版本迭代更新
  - 允许包含文件路径、入口、模块结构、依赖与风险清单

---

## 11. 建议的后续文档（可选但强烈建议）

为提升可执行性，建议在 docs 下补齐：
- `docs/user-guide/modeltable_user_guide.md`：面向用户的 ModelTable 操作指南（Living Doc）
- `docs/runbooks/`：按平台记录集成经验（desktop/android/linux/macos）
- `docs/design/`：UI 规范、token、导航规则、审视报告
- `docs/plans/`：迭代计划（由 Iteration Workflow 生成）
